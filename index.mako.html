<html>
<script>
    AUTOBAHN_DEBUG = true;
</script>
<script src="/static/autobahn.min.js"></script>
<script src="/static/jquery-3.3.1.min.js"></script>

<script>

var connection = new autobahn.Connection({url: 'ws://lemonchat.nitric.co.za:9000/', realm: 'realm1'});
var url = "http://lemonchat.nitric.co.za";

$(function() {
    connection.onopen = function (session) {
        function conversationlist(args) {
            $.get('/conversationlist?user_id=${user_id}&agent=${agent}', function(data) {
                // re-populate conversation list.
                $("#conversations").empty();
                
                if (data.length > 0) {
                    $(data).each(function(index, value) {
                        $('#conversations').append(
                            $('<li>').append(
                                $('<a class="conversationchange">').attr('conversation_id', value['id']).append(
                                    $('<span>').attr('class', 'tab').append(value['subject'] + " (" + value['prettydate'] + ") ")
                        )));

                    });
                    $('.conversationchange').on('click', function(d) {
                        var conversation_id = $(this).attr('conversation_id');
                        conversationchange(conversation_id);
                    });                    
                    $("#conversationbox").slideDown();
                    
                }
                
            });
        }
        session.subscribe('lemonchat.conversations', conversationlist);
        conversationlist();

        var activeconversation = 0;
        var activeconversation_id = 0;

        function conversationrefresh() {
            ## Change conversation view. 
            $("#conversationarea").hide()
            $("#conversationarea").empty();
            $.get(url+"/conversationchange?conversation_id=" + activeconversation_id, function(data) {


                if (data.length > 0) {
                    $(data).each(function(index, value) {
                        $('#conversationarea').append("<p>"+value['message']+"</p>");
                    });                  
                }

                $("#conversationarea").append('<div class="mblm-item mblm-item-right"><textarea id="newmessage" placeholder=\"Add a message to this conversation...\"></textarea><button id="newmessagebutton"><i class=\"zmdi zmdi-mail-send\">New Message</i></button></div>');


                $('#newmessagebutton').on('click', function(d) {
                    data = {user_id: "${user_id}", conversation_id: activeconversation_id, newmessage: $("#newmessage").val()};
                    $.post(url+"/newmessage", data=data, function(data) {

                    });
                });
            });
            $("#conversationarea").show();
        }

        function conversationchange(conversation_id) {
            if (activeconversation) {
                console.log("Unsubscribing from "+activeconversation_id)
                session.unsubscribe(activeconversation['_handler']['handler']['value']);
                activeconversation = 0;
                activeconversation_id = 0;
            }
            activeconversation_id = conversation_id
            conversationrefresh();
            topic = 'lemonchat.conversation.'+conversation_id
            activeconversation = session.subscribe(topic, conversationrefresh);
            console.log("Subscribing to " + activeconversation)
        }


        $("#newconversationbutton").on('click', function(a) {
            data = {user_id: "${user_id}", subject: $("#subject").val()};
            $.post(url+"/newconversation", data=data, function(conversation_id) {
                conversationchange(conversation_id);
            });    
        });

        console.log("Connection opened.");
    }

    connection.onclose = function (reason, details) {
        console.log("Connection closed: "+reason);
        setTimeout(connection.open, 15000);
    }

    connection.open();
});    


</script>
<div id="conversationbox" style="display:None;">
Existing Conversations:
<ul id="conversations">
</ul>
</div>
Conversation Area:
<div id="conversationarea" class="mb-list">
    <div class="mbl-messages c-overflow">    
    
        <div class="mbl-compose">
            Hello ${user_id}. How can we help you today?
        </div>
        <div class="mblm-item mblm-item-right">
        <textarea id='subject' placeholder="Subject of new conversation..."></textarea>
        <button id='newconversationbutton'><i class="zmdi zmdi-mail-send">New Conversation</i></button>
        </div>
    
        <!-- <div class="mblm-item mblm-item-right">
            <div>
                Cras mattis consectetur purus sit amet fermentum. Cras justo odio, dapibus ac facilisis in, egestas eget quam. Integer posuere erat a ante venenatis dapibus posuere velit aliquet. Sed posuere consectetur est at lobortis. Aenean lacinia bibendum nulla sed consectetur. Aenean eu leo quam. Pellentesque ornare sem lacinia quam venenatis vestibulum.                                    </div>
            <small>6:15 PM</small>
        </div> -->

    </div>
</div>
</html>
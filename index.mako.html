<%!
import settings
%>
<html>
<script>
    AUTOBAHN_DEBUG = true;
</script>
<script src="/static/autobahn.min.js"></script>
<script src="/static/jquery-3.3.1.min.js"></script>

<script>

var connection = new autobahn.Connection({url: 'wss://masterpenny.com:9000/', realm: 'realm1'});
var url = "${settings.weburl}";

$(function() {
    connection.onopen = function (session) {
        function conversationlist(args) {
            $.get('/conversationlist?user_id=${user_id}&agent=${agent}', function(data) {
                //find the conversation tab and repopulate but keep the new message text
                $("#conversations").empty();
                
                if (data.length > 0) {
                    $(data).each(function(index, value) {
                        $('#conversations').append(
                            $('<li>').append(
                                $('<a class="conversationchange">').attr('conversation_id', value['id']).append(
                                    $('<span>').attr('class', 'tab').append(value['subject'] + " (" + value['prettydate'] + ") ")
                        )));
                    });
                    $('.conversationchange').on('click', function(d) {
                        var conversation_id = $(this).attr('conversation_id');
                        conversationchange(conversation_id);
                    });                    
                    $("#conversationbox").slideDown();
                }
                $("#conversations").show();
            });
        }
        session.subscribe('lemonchat.conversations', conversationlist);
        conversationlist();

        var activeconversation = 0;
        var activeconversation_id = 0;

        function addnewmessage() {
            newmessage = $("#newmessage"+activeconversation_id).val();
            console.log("Help");
            data = {user_id: "${user_id}", conversation_id: activeconversation_id, newmessage: newmessage};
            $.post(url+"/newmessage", data=data, function(data) {

            });
            $("#newmessage"+activeconversation_id).val("");
        }

        function conversationrefresh() {
            ## Change conversation view. 
            $("#conversationarea").children().hide();
            var conversationdivs = $("#conversationarea").find("div#"+activeconversation_id);

            if (!conversationdivs.length) {
                console.log("Appending conversation area");
                
                $("#conversationarea").append('<div id="'+activeconversation_id+'"><div class="previousmessagediv"></div><div class="newmessagediv"><textarea id="newmessage'+activeconversation_id+'" placeholder=\"Add a message to this conversation...\"></textarea><button id="newmessagebutton'+activeconversation_id+'">New Message</button></div></div>');

                $('#newmessagebutton'+activeconversation_id).on('click', addnewmessage);


                $(function () {
                    $("#newmessage"+activeconversation_id).keypress(function (e) {
                        var code = (e.keyCode ? e.keyCode : e.which);
                        if (code == 13) {
                            $('#newmessagebutton'+activeconversation_id).trigger('click');
                            return true;
                        }
                    });
                });

                conversationdivs = $("#conversationarea").find("div#"+activeconversation_id);
            }
            var conversationdiv = $(conversationdivs[0]);
            var previousmessagesdiv = $(conversationdiv.find('.previousmessagediv')[0]);
            //conversationdiv.not(".newmessagediv").remove();

            $.get(url+"/conversationchange?conversation_id=" + activeconversation_id, function(data) {
                previousmessagesdiv.empty();
                if (data.length > 0) {
                    $($(data.reverse())).each(function(index, value) {
                        previousmessagesdiv.prepend("<div><p>"+value['user_id']+": "+value['message']+"</p></div>");
                    });                  
                }
            });
            conversationdiv.show();
        }

        function conversationchange(conversation_id) {
            if (activeconversation) {
                console.log("Unsubscribing from "+activeconversation_id);
                session.unsubscribe(activeconversation['_handler']['handler']['value']);
                activeconversation = 0;
                activeconversation_id = 0;
            }
            activeconversation_id = conversation_id;
            conversationrefresh();
            topic = 'lemonchat.conversation.'+conversation_id;
            activeconversation = session.subscribe(topic, conversationrefresh);
            console.log("Subscribing to " + activeconversation_id);
        }

        $("#newconversationbutton").on('click', function(a) {
            data = {user_id: "${user_id}", subject: $("#subject").val()};
            $.post(url+"/newconversation", data=data, function(conversation_id) {
                conversationchange(conversation_id);
            });    
        });

        console.log("Connection opened.");
    }

    connection.onclose = function (reason, details) {
        console.log("Connection closed: "+reason);
        setTimeout(connection.open, 15000);
    }

    connection.open();
});    


</script>
<div id="conversationbox" style="display:None;">
Existing Conversations:
<ul id="conversations">
</ul>
</div>
<div class="mblm-item mblm-item-right">
<textarea id='subject' placeholder="Topic of new conversation..."></textarea><br>
<button id='newconversationbutton'><i>New Conversation</i></button>
</div>
<hr>
<div id="conversationarea"></div>
</html>